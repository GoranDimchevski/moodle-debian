#! /bin/sh /usr/share/dpatch/dpatch-run
## CVE-2008-1502.dpatch by Nico Golde <nion@debian.org>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: No description.

@DPATCH@
diff -urNad moodle-1.8.2~/lib/kses.php moodle-1.8.2/lib/kses.php
--- moodle-1.8.2~/lib/kses.php	2006-03-03 03:01:53.000000000 +0100
+++ moodle-1.8.2/lib/kses.php	2008-07-20 18:07:35.000000000 +0200
@@ -469,10 +469,12 @@
 # handling whitespace and HTML entities.
 ###############################################################################
 {
-  return preg_replace('/^((&[^;]*;|[\sA-Za-z0-9])*)'.
-                      '(:|&#0*58;|&#[Xx]3[Aa];)\s*/e',
-                      'kses_bad_protocol_once2("\\1", $allowed_protocols)',
-                      $string);
+  $string2 = preg_split('/:|&#58;|&#x3a;/i', $string, 2);
+  if(isset($string2[1]) && !preg_match('%/\?%',$string2[0]))
+  {
+    $string = kses_bad_protocol_once2($string2[0],$allowed_protocols).trim($string2[1]);
+  }
+  return $string;
 } # function kses_bad_protocol_once
 
 
diff -urNad moodle-1.8.2~/lib/weblib.php moodle-1.8.2/lib/weblib.php
--- moodle-1.8.2~/lib/weblib.php	2007-07-04 04:55:40.000000000 +0200
+++ moodle-1.8.2/lib/weblib.php	2008-07-20 18:06:11.000000000 +0200
@@ -1758,6 +1758,7 @@
             }
             $arreach['value'] = preg_replace("/j\s*a\s*v\s*a\s*s\s*c\s*r\s*i\s*p\s*t/i", "Xjavascript", $arreach['value']);
             $arreach['value'] = preg_replace("/e\s*x\s*p\s*r\s*e\s*s\s*s\s*i\s*o\s*n/i", "Xexpression", $arreach['value']);
+            $arreach['value'] = preg_replace("/b\s*i\s*n\s*d\s*i\s*n\s*g/i", "Xbinding", $arreach['value']);
         } else if ($arreach['name'] == 'href') {
             //Adobe Acrobat Reader XSS protection
             $arreach['value'] = preg_replace('/(\.(pdf|fdf|xfdf|xdp|xfd))[^a-z0-9_\.\-].*$/i', '$1', $arreach['value']);
