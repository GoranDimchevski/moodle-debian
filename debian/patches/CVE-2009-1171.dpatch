#! /bin/sh /usr/share/dpatch/dpatch-run
## CVE-2009-1171.dpatch by Nico Golde <nion@debian.org>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: No description.

@DPATCH@
diff -urNad moodle-1.8.2.dfsg~/filter/algebra/algebradebug.php moodle-1.8.2.dfsg/filter/algebra/algebradebug.php
--- moodle-1.8.2.dfsg~/filter/algebra/algebradebug.php	2007-03-15 03:29:15.000000000 +0100
+++ moodle-1.8.2.dfsg/filter/algebra/algebradebug.php	2009-04-01 13:45:45.000000000 +0200
@@ -16,6 +16,8 @@
         }
     }
 
+    require_once($CFG->dirroot.'/filter/tex/lib.php');
+
     $CFG->texfilterdir = "filter/tex";
     $CFG->algebrafilterdir = "filter/algebra";
     $CFG->algebraimagedir = "filter/algebra";
@@ -233,6 +235,7 @@
         } 
         $commandpath = "";
         $cmd = "";
+        $texexp = tex_sanitize_formula($texexp);
         $texexp = escapeshellarg($texexp);
         switch (PHP_OS) {
             case "Linux":
diff -urNad moodle-1.8.2.dfsg~/filter/algebra/pix.php moodle-1.8.2.dfsg/filter/algebra/pix.php
--- moodle-1.8.2.dfsg~/filter/algebra/pix.php	2007-03-15 03:29:15.000000000 +0100
+++ moodle-1.8.2.dfsg/filter/algebra/pix.php	2009-04-01 13:46:09.000000000 +0200
@@ -18,6 +18,7 @@
 
     // disable moodle specific debug messages
     disable_debugging();
+    require_once($CFG->dirroot.'/filter/tex/lib.php');
 
     require_once($CFG->libdir.'/filelib.php');
 
@@ -54,6 +55,7 @@
             $texexp = str_replace('&gt;','>',$texexp);
             $texexp = preg_replace('!\r\n?!',' ',$texexp);
             $texexp = '\Large ' . $texexp;
+            $texexp = tex_sanitize_formula($texexp);
             $texexp = escapeshellarg($texexp);
 
             if ((PHP_OS == "WINNT") || (PHP_OS == "WIN32") || (PHP_OS == "Windows")) {
diff -urNad moodle-1.8.2.dfsg~/filter/tex/latex.php moodle-1.8.2.dfsg/filter/tex/latex.php
--- moodle-1.8.2.dfsg~/filter/tex/latex.php	2006-05-22 04:00:42.000000000 +0200
+++ moodle-1.8.2.dfsg/filter/tex/latex.php	2009-04-01 13:46:57.000000000 +0200
@@ -44,9 +44,10 @@
          * @return string the latex document
          */
         function construct_latex_document( $formula, $fontsize=12 ) {
-            // $fontsize don't affects to formula's size. $density can change size
 
             global $CFG;
+
+            $formula = tex_sanitize_formula($formula);
             $doc =  "\\documentclass[{$fontsize}pt]{article}\n"; 
             $doc .=  $CFG->filter_tex_latexpreamble;
             $doc .= "\\pagestyle{empty}\n";
diff -urNad moodle-1.8.2.dfsg~/filter/tex/lib.php moodle-1.8.2.dfsg/filter/tex/lib.php
--- moodle-1.8.2.dfsg~/filter/tex/lib.php	1970-01-01 01:00:00.000000000 +0100
+++ moodle-1.8.2.dfsg/filter/tex/lib.php	2009-04-01 13:48:13.000000000 +0200
@@ -0,0 +1,37 @@
+<?php  //$Id$
+
+function tex_sanitize_formula($texexp) {
+    /// Check $texexp against blacklist (whitelisting could be more complete but also harder to maintain)
+    $tex_blacklist = array(
+        'include','def','command','loop','repeat','open','toks','output',
+        'input','catcode','name','^^',
+        '\every','\errhelp','\errorstopmode','\scrollmode','\nonstopmode',
+        '\batchmode','\read','\write','csname','\newhelp','\uppercase',
+        '\lowercase','\relax','\aftergroup',
+        '\afterassignment','\expandafter','\noexpand','\special'
+    );
+
+    return  str_ireplace($tex_blacklist, 'forbiddenkeyword', $texexp);
+}
+
+/**
+ * Purge all caches when settings changed.
+ */
+function filter_tex_updatedcallback($name) {
+    global $CFG;
+
+    if (file_exists("$CFG->dataroot/filter/tex")) {
+        remove_dir("$CFG->dataroot/filter/tex");
+    }
+    if (file_exists("$CFG->dataroot/filter/algebra")) {
+        remove_dir("$CFG->dataroot/filter/algebra");
+    }
+    if (file_exists("$CFG->dataroot/temp/latex")) {
+        remove_dir("$CFG->dataroot/temp/latex");
+    }
+
+    delete_records('cache_filters', 'filter', 'tex');
+    delete_records('cache_filters', 'filter', 'algebra');
+}
+
+?>
diff -urNad moodle-1.8.2.dfsg~/filter/tex/pix.php moodle-1.8.2.dfsg/filter/tex/pix.php
--- moodle-1.8.2.dfsg~/filter/tex/pix.php	2007-03-15 03:29:16.000000000 +0100
+++ moodle-1.8.2.dfsg/filter/tex/pix.php	2009-04-01 13:49:11.000000000 +0200
@@ -20,8 +20,9 @@
     disable_debugging();
 
     require_once($CFG->libdir.'/filelib.php');
+    require_once($CFG->dirroot.'/filter/tex/lib.php');
+    require_once($CFG->dirroot.'/filter/tex/latex.php');
     require_once('defaultsettings.php' );
-    require_once('latex.php');
 
     $CFG->texfilterdir = 'filter/tex';
     $CFG->teximagedir  = 'filter/tex';
@@ -68,6 +69,7 @@
                 $texexp = str_replace('&gt;','>',$texexp);
                 $texexp = preg_replace('!\r\n?!',' ',$texexp);
                 $texexp = '\Large ' . $texexp;
+                $texexp = tex_sanitize_formula($texexp);
                 $texexp = escapeshellarg($texexp);
 
                 if ((PHP_OS == "WINNT") || (PHP_OS == "WIN32") || (PHP_OS == "Windows")) {
diff -urNad moodle-1.8.2.dfsg~/filter/tex/texdebug.php moodle-1.8.2.dfsg/filter/tex/texdebug.php
--- moodle-1.8.2.dfsg~/filter/tex/texdebug.php	2007-03-15 03:29:16.000000000 +0100
+++ moodle-1.8.2.dfsg/filter/tex/texdebug.php	2009-04-01 13:52:03.000000000 +0200
@@ -16,6 +16,9 @@
         }
     }
 
+    require_once($CFG->dirroot.'/filter/tex/lib.php');
+    require_once($CFG->dirroot.'/filter/tex/latex.php');
+
     $CFG->texfilterdir = "filter/tex";
     $CFG->teximagedir = "filter/tex";
 
@@ -111,6 +114,7 @@
             }
             $commandpath = "";
             $cmd = "";
+            $texexp = tex_sanitize_formula($texexp);
             $texexp = escapeshellarg($texexp);
             switch (PHP_OS) {
                 case "Linux":
diff -urNad moodle-1.8.2.dfsg~/filter/tex/texed.php moodle-1.8.2.dfsg/filter/tex/texed.php
--- moodle-1.8.2.dfsg~/filter/tex/texed.php	2007-03-15 03:29:16.000000000 +0100
+++ moodle-1.8.2.dfsg/filter/tex/texed.php	2009-04-01 13:52:26.000000000 +0200
@@ -6,6 +6,7 @@
     $nomoodlecookie = true;     // Because it interferes with caching
 
     require_once("../../config.php");
+    require_once($CFG->dirroot.'/filter/tex/lib.php');
 
     if (empty($CFG->textfilters)) {
         error ('Filter not enabled!');
@@ -32,6 +33,7 @@
             make_upload_directory($CFG->teximagedir);
         }
         $pathname = "$CFG->dataroot/$CFG->teximagedir/$image";
+        $texexp = tex_sanitize_formula($texexp);
         $texexp = escapeshellarg($texexp);
 
         switch (PHP_OS) {
diff -urNad moodle-1.8.2.dfsg~/lib/db/upgrade.php moodle-1.8.2.dfsg/lib/db/upgrade.php
--- moodle-1.8.2.dfsg~/lib/db/upgrade.php	2007-07-07 05:36:35.000000000 +0200
+++ moodle-1.8.2.dfsg/lib/db/upgrade.php	2009-04-01 13:56:40.000000000 +0200
@@ -697,6 +697,11 @@
         set_field('user', 'mnethostid', $CFG->mnet_localhost_id, 'username', 'guest');
     }
 
+    if ($result && $oldversion < 2007021581) {
+        require_once("$CFG->dirroot/filter/tex/lib.php");
+        filter_tex_updatedcallback(null);
+    }
+
     return $result;
 
 }
diff -urNad moodle-1.8.2.dfsg~/version.php moodle-1.8.2.dfsg/version.php
--- moodle-1.8.2.dfsg~/version.php	2007-07-08 15:51:07.000000000 +0200
+++ moodle-1.8.2.dfsg/version.php	2009-04-01 13:57:06.000000000 +0200
@@ -6,7 +6,7 @@
 // This is compared against the values stored in the database to determine
 // whether upgrades should be performed (see lib/db/*.php)
 
-   $version = 2007021520;   // YYYYMMDD   = date of the 1.8 branch (don't change)
+   $version = 2007021581;   // YYYYMMDD   = date of the 1.8 branch (don't change)
                             //         X  = release number 1.8.[0,1,2,3...]
                             //          Y = micro-increments between releases
 
