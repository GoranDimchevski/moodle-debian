#! /bin/sh /usr/share/dpatch/dpatch-run
## CVE-2009-1171.dpatch by Francois Marier <francois@debian.org>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: Filter out dangerous LaTeX characters

@DPATCH@
diff --git a/filter/tex/latex.php b/filter/tex/latex.php
index 9852871..fa4c204 100644
--- a/filter/tex/latex.php
+++ b/filter/tex/latex.php
@@ -44,9 +44,11 @@
          * @return string the latex document
          */
         function construct_latex_document( $formula, $fontsize=12 ) {
-            // $fontsize don't affects to formula's size. $density can change size
-
             global $CFG;
+
+            $formula = tex_sanitize_formula($formula);
+
+            // $fontsize don't affects to formula's size. $density can change size
             $doc =  "\\documentclass[{$fontsize}pt]{article}\n"; 
             $doc .=  $CFG->filter_tex_latexpreamble;
             $doc .= "\\pagestyle{empty}\n";
diff --git a/filter/tex/lib.php b/filter/tex/lib.php
index 5743efd..e1f67d7 100644
--- a/filter/tex/lib.php
+++ b/filter/tex/lib.php
@@ -34,8 +34,22 @@ function tex_filter_get_executable($debug=false) {
     error($error_message1);
 }
 
+function tex_sanitize_formula($texexp) {
+    /// Check $texexp against blacklist (whitelisting could be more complete but also harder to maintain)
+    $tex_blacklist = array(
+        'include','def','command','loop','repeat','open','toks','output',
+        'input','catcode','name','^^',
+        '\every','\errhelp','\errorstopmode','\scrollmode','\nonstopmode',
+        '\batchmode','\read','\write','csname','\newhelp','\uppercase',
+        '\lowercase','\relax','\aftergroup',
+        '\afterassignment','\expandafter','\noexpand','\special'
+    );
+
+    return  str_ireplace($tex_blacklist, 'forbiddenkeyword', $texexp);
+}
 
 function tex_filter_get_cmd($pathname, $texexp) {
+    $texexp = tex_sanitize_formula($texexp);
     $texexp = escapeshellarg($texexp);
     $executable = tex_filter_get_executable(false);
 
diff --git a/filter/tex/texdebug.php b/filter/tex/texdebug.php
index ea5f7d4..5f9b444 100644
--- a/filter/tex/texdebug.php
+++ b/filter/tex/texdebug.php
@@ -3,8 +3,6 @@
       // If not, it obtains the corresponding TeX expression from the cache_tex db table
       // and uses mimeTeX to create the image file
 
-    $nomoodlecookie = true;     // Because it interferes with caching
-
     require_once("../../config.php");
 
     if (empty($CFG->textfilters)) {
@@ -23,6 +21,9 @@
     $action = optional_param('action', '', PARAM_ALPHA);
     $texexp = optional_param('tex', '', PARAM_RAW);
 
+    require_login();
+    require_capability('moodle/site:config', get_context_instance(CONTEXT_SYSTEM), $USER->id); /// Required cap to run this. MDL-18552
+
     $query = urldecode($_SERVER['QUERY_STRING']);
     error_reporting(E_ALL);
     $output = '';
diff --git a/lib/db/upgrade.php b/lib/db/upgrade.php
index de347c5..890f991 100644
--- a/lib/db/upgrade.php
+++ b/lib/db/upgrade.php
@@ -3094,6 +3094,13 @@ function xmldb_main_upgrade($oldversion=0) {
             upgrade_main_savepoint($result, 2007101532.10);
     }
 
+    if ($result && $oldversion < 2007101545.01) {
+        require_once("$CFG->dirroot/filter/tex/lib.php");
+        filter_tex_updatedcallback(null);
+    /// Main savepoint reached
+        upgrade_main_savepoint($result, 2007101545.01);
+    }
+
     return $result;
 }
 
diff --git a/version.php b/version.php
index d9303f8..8839b53 100644
--- a/version.php
+++ b/version.php
@@ -6,7 +6,7 @@
 // This is compared against the values stored in the database to determine
 // whether upgrades should be performed (see lib/db/*.php)
 
-    $version = 2007101540;  // YYYYMMDD      = date of the 1.9 branch (don't change)
+    $version = 2007101540.01;  // YYYYMMDD      = date of the 1.9 branch (don't change)
                             //         X     = release number 1.9.[0,1,2,3,4,5...]
                             //          Y.YY = micro-increments between releases
 
